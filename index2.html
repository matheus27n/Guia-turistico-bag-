<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guia Turístico Colaborativo</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    #map{height:100%;width:100%;z-index:10;transition:box-shadow .5s}
    .modal{transition:opacity .3s}
    .map-selection-mode{box-shadow:0 0 0 4px rgba(59,130,246,.7);animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}70%{box-shadow:0 0 0 10px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
    .star-rating i{cursor:pointer;transition:color .2s;color:#d1d5db}
    .star-rating:not(.rated) i:hover,.star-rating:not(.rated) i:hover~i{color:#eab308}
    .star-rating .rated-star{color:#f59e0b}
    .star-rating.rated i{cursor:default}
    /* dropdown de sugestões */
    #address-suggestions > div { border-bottom: 1px solid #eee; }
    #address-suggestions > div:last-child { border-bottom: 0; }
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

  <!-- App -->
  <div id="app" class="relative h-screen w-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-full md:w-1/3 lg:w-1/4 h-screen bg-white shadow-lg flex flex-col z-20">
      <header class="p-4 border-b bg-white">
        <div id="auth-container" class="mb-4"></div>
        <h1 class="text-2xl font-bold text-gray-800">Guia de Bagé</h1>
        <p class="text-sm text-gray-500">Explore pontos incríveis da cidade!</p>

        <!-- Busca principal -->
        <div class="mt-4 flex">
          <input id="addressSearch" type="text" placeholder="Buscar endereço..." class="w-full px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
          <button onclick="searchAddress()" class="bg-blue-500 text-white px-3 hover:bg-blue-600">
            <i class="fas fa-search"></i>
          </button>
          <button onclick="getCurrentLocation()" class="bg-gray-600 text-white px-4 rounded-r-lg hover:bg-gray-700" title="Usar minha localização atual">
            <i class="fas fa-crosshairs"></i>
          </button>
        </div>
      </header>

      <!-- Filtros -->
      <div class="p-4 border-b">
        <h2 class="font-semibold text-gray-700 mb-2">Filtrar por Categoria</h2>
        <div class="flex space-x-2">
          <button onclick="filterPoints('todos', this)" class="filter-btn flex-1 bg-blue-500 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-600 transition-colors">
            <i class="fas fa-globe-americas mr-1"></i> Todos
          </button>
          <button onclick="filterPoints('Comida', this)" class="filter-btn flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm hover:bg-gray-300 transition-colors">
            <i class="fas fa-utensils mr-1"></i> Comida
          </button>
          <button onclick="filterPoints('Lazer', this)" class="filter-btn flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm hover:bg-gray-300 transition-colors">
            <i class="fas fa-sun mr-1"></i> Lazer
          </button>
          <button onclick="filterPoints('Vida Noturna', this)" class="filter-btn flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm hover:bg-gray-300 transition-colors">
            <i class="fas fa-moon mr-1"></i> Noite
          </button>
        </div>
      </div>

      <!-- Lista -->
      <div id="points-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

      <footer class="p-4 border-t bg-white">
        <button onclick="openAddPointModal()" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105 shadow-md">
          <i class="fas fa-plus-circle mr-2"></i> Adicionar Novo Ponto
        </button>
      </footer>
    </aside>

    <!-- Mapa -->
    <main class="flex-1 h-screen relative">
      <div id="map"></div>
    </main>
  </div>

  <!-- Modal: Adicionar/Editar -->
  <div id="addPointModal" class="modal fixed inset-0 flex items-center justify-center z-50 opacity-0 pointer-events-none">
    <div class="bg-white rounded-xl shadow-2xl p-8 m-4 w-full max-w-lg transform transition-transform scale-95">
      <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6">Adicionar um Novo Ponto</h2>
      <form id="addPointForm">
        <input id="pointId" type="hidden">

        <div class="space-y-4">
          <input id="pointName" type="text" placeholder="Nome do Ponto Turístico" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>

          <!-- endereço com autocomplete -->
          <div class="relative">
            <input id="pointAddress" type="text" placeholder="Digite o endereço para buscar..." onkeyup="autocompleteAddress(event)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <div id="address-suggestions" class="absolute w-full bg-white border border-gray-300 rounded-b-lg mt-1 z-50 max-h-48 overflow-y-auto"></div>
          </div>

          <textarea id="pointDescription" placeholder="Descrição do local" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" required></textarea>

          <select id="pointCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            <option value="" disabled selected>Selecione a categoria</option>
            <option value="Comida">Comida</option>
            <option value="Lazer">Lazer</option>
            <option value="Vida Noturna">Vida Noturna</option>
          </select>

          <div>
            <label for="pointRating" class="block text-sm font-medium text-gray-700">Avaliação inicial (0 a 5)</label>
            <input id="pointRating" type="number" step="0.1" min="0" max="5" placeholder="Ex: 4.5" class="w-full px-4 py-3 mt-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- seleção de localização -->
          <div class="space-y-2">
            <div class="text-sm text-gray-600 p-2 border-l-4 border-blue-400 bg-blue-50">
              <i class="fas fa-info-circle mr-2"></i>
              Defina a localização do ponto: <b>selecionar no mapa</b> ou <b>usar minha localização</b>.
            </div>
            <div class="flex gap-2">
              <button type="button" onclick="startMapPick()" class="px-3 py-2 rounded bg-blue-100 text-blue-700 hover:bg-blue-200">
                <i class="fas fa-location-dot mr-1"></i> Selecionar no mapa
              </button>
              <button type="button" onclick="useMyLocation()" class="px-3 py-2 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">
                <i class="fas fa-crosshairs mr-1"></i> Usar minha localização
              </button>
              <span id="locStatus" class="text-xs text-gray-500 self-center"></span>
            </div>
          </div>

          <input id="pointLat" type="hidden" required>
          <input id="pointLng" type="hidden" required>
        </div>

        <div class="mt-8 flex justify-end space-x-3">
          <button type="button" onclick="closeAddPointModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancelar</button>
          <button type="submit" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalhes -->
  <div id="detailsModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 opacity-0 pointer-events-none">
    <div id="detailsModalContent" class="bg-white rounded-xl shadow-2xl m-4 w-full max-w-lg transform transition-transform scale-95 overflow-hidden"></div>
  </div>

  <!-- App -->
  <script type="module">
    /* ===== Firebase v9 ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, GeoPoint } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBAIRqjIXtoxWibRFkrPKnblIXHGRjtx3w",
      authDomain: "guia-turistica-bage.firebaseapp.com",
      projectId: "guia-turistica-bage",
      storageBucket: "guia-turistica-bage.appspot.com",
      messagingSenderId: "973015664911",
      appId: "1:973015664911:web:089ae5885740b7eb05567a",
      measurementId: "G-VDL43642TL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const pointsCollection = collection(db, "dados-guia");

    /* ===== Mapa ===== */
    const initialCoords = [-31.3314, -54.1085]; // Bagé
    const map = L.map("map").setView(initialCoords, 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let markers = L.layerGroup().addTo(map);
    let touristPoints = [];
    let tempMarker = null;

    function getCategoryColor(category) {
      switch (category) { case "Comida": return "#f97316"; case "Lazer": return "#14b8a6"; case "Vida Noturna": return "#6366f1"; default: return "#6b7280"; }
    }
    function getCategoryClass(category) {
      switch (category) { case "Comida": return "bg-orange-500"; case "Lazer": return "bg-teal-500"; case "Vida Noturna": return "bg-indigo-500"; default: return "bg-gray-500"; }
    }
    function getCategoryIcon(category) {
      const iconHtml = `<i class="fa-solid fa-map-marker-alt fa-2x" style="color:${getCategoryColor(category)}"></i>`;
      return L.divIcon({ html: iconHtml, className:"dummy-class", iconSize:[30,42], iconAnchor:[15,42], popupAnchor:[0,-35] });
    }

    /* ===== Auth UI ===== */
    const authContainer = document.getElementById("auth-container");
    onAuthStateChanged(auth, (user) => updateAuthUI(user));

    function updateAuthUI(user) {
      if (user) {
        authContainer.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <img src="${user.photoURL}" class="w-10 h-10 rounded-full mr-3" alt="Foto do usuário">
              <div>
                <p class="font-semibold text-gray-800">${user.displayName}</p>
                <p class="text-xs text-gray-500">Bem-vindo(a)!</p>
              </div>
            </div>
            <button id="logoutBtn" class="text-sm text-red-500 hover:text-red-700 font-semibold">Sair</button>
          </div>`;
        document.getElementById("logoutBtn").onclick = logout;
      } else {
        authContainer.innerHTML = `
          <button id="loginBtn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 transition-all flex items-center justify-center">
            <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google" class="w-5 h-5 mr-2">
            Entrar com Google
          </button>`;
        document.getElementById("loginBtn").onclick = signInWithGoogle;
      }
    }

    async function signInWithGoogle() {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); }
      catch (error) { console.error("LOGIN ERROR:", error.code, error.message); alert(`Não foi possível fazer o login.\n(${error.code})`); }
    }
    async function logout(){ try{ await signOut(auth); }catch(e){ console.error(e); } }

    /* ===== Firestore realtime ===== */
    function listenForPoints() {
      onSnapshot(pointsCollection, (qs) => {
        touristPoints = [];
        qs.forEach((d) => {
          const data = d.data();
          touristPoints.push({
            id: d.id,
            name: data["nome-ponto"],
            address: data.endereco,
            description: data.descricao,
            category: data.categoria,
            coords: [data.coordenadas.latitude, data.coordenadas.longitude],
            rating: data.avaliacao || 0,
            votes: data.votos || 0
          });
        });
        renderPoints();
      }, (err) => {
        console.error("Firestore error:", err.code, err.message);
        alert("Não foi possível conectar ao banco de dados.");
      });
    }

    /* ===== Render ===== */
    function renderPoints(pointsToRender = touristPoints) {
      const pointsList = document.getElementById("points-list");
      pointsList.innerHTML = "";
      markers.clearLayers();

      if (pointsToRender.length === 0) {
        pointsList.innerHTML = `
          <div class="text-center text-gray-500 p-8">
            <p class="mb-2"><i class="fas fa-map-signs fa-3x text-gray-400"></i></p>
            <h3 class="font-semibold text-lg">Nenhum ponto turístico cadastrado.</h3>
            <p class="text-sm">Seja o primeiro a adicionar um local clicando no botão abaixo!</p>
          </div>`;
        return;
      }

      pointsToRender.sort((a,b)=>b.rating-a.rating);

      pointsToRender.forEach((point) => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md hover:border-blue-400 transition-all";
        card.onclick = () => { map.setView(point.coords, 16); openDetailsModal(point.id); };
        card.innerHTML = `
          <h3 class="font-bold text-lg text-gray-800">${point.name}</h3>
          <p class="text-sm text-gray-600 truncate">${point.description}</p>
          <div class="flex justify-between items-center mt-3">
            <span class="text-xs font-semibold text-white px-2 py-1 rounded-full ${getCategoryClass(point.category)}">${point.category}</span>
            <span class="text-yellow-500 font-bold flex items-center"><i class="fas fa-star mr-1"></i> ${point.rating>0?point.rating.toFixed(1):"N/A"}</span>
          </div>`;
        pointsList.appendChild(card);

        const marker = L.marker(point.coords, { icon: getCategoryIcon(point.category) }).addTo(markers);
        marker.on("click", () => openDetailsModal(point.id));
      });
    }

    /* ===== CRUD ===== */
    document.getElementById("addPointForm").onsubmit = savePoint;

    async function savePoint(e){
      e.preventDefault();

      const id = document.getElementById("pointId").value;
      const lat = parseFloat(document.getElementById("pointLat").value);
      const lng = parseFloat(document.getElementById("pointLng").value);
      const ratingInput = parseFloat(document.getElementById("pointRating").value);

      if (Number.isNaN(lat) || Number.isNaN(lng)) {
        alert("Defina a localização do ponto (no mapa ou usando sua localização).");
        return;
      }

      const data = {
        "nome-ponto": document.getElementById("pointName").value,
        endereco: document.getElementById("pointAddress").value,
        descricao: document.getElementById("pointDescription").value,
        categoria: document.getElementById("pointCategory").value,
        coordenadas: new GeoPoint(lat, lng)
      };

      try {
        if (id) {
          const ref = doc(db, "dados-guia", id);
          const updateData = { ...data };
          if (!Number.isNaN(ratingInput)) { updateData.avaliacao = ratingInput; updateData.votos = 1; }
          await updateDoc(ref, updateData);
        } else {
          const initial = !Number.isNaN(ratingInput) ? ratingInput : 0;
          data.avaliacao = initial;
          data.votos = initial > 0 ? 1 : 0;
          await addDoc(pointsCollection, data);
        }
        closeAddPointModal();
      } catch (err) {
        console.error("savePoint", err);
        alert("Erro ao salvar. Tente novamente.");
      }
    }

    async function deletePoint(id){
      if(!auth.currentUser){ alert("Você precisa estar logado para excluir."); return; }
      if(!confirm("Tem certeza que deseja excluir este ponto?")) return;
      try{ await deleteDoc(doc(db,"dados-guia",id)); closeDetailsModal(); }
      catch(err){ console.error(err); alert("Erro ao excluir."); }
    }

    /* ===== Filtros ===== */
    function filterPoints(category, btnEl){
      document.querySelectorAll(".filter-btn").forEach(b=>{
        b.classList.remove("bg-blue-500","text-white"); b.classList.add("bg-gray-200","text-gray-700");
      });
      btnEl.classList.add("bg-blue-500","text-white");
      btnEl.classList.remove("bg-gray-200","text-gray-700");

      renderPoints(category==="todos"?touristPoints:touristPoints.filter(p=>p.category===category));
    }

    /* ===== Busca / Geoloc ===== */
    async function searchAddress(){
      const q = document.getElementById("addressSearch").value.trim();
      if(q.length<3) return;
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=br&viewbox=-54.3,-31.5,-53.9,-31.1&bounded=1`;
        const res=await fetch(url,{headers:{'Accept-Language':'pt-BR'}});
        const results=await res.json();
        if(results.length>0){ const {lat,lon}=results[0]; map.setView([parseFloat(lat),parseFloat(lon)],17); }
        else{ alert("Endereço não encontrado."); }
      }catch{ alert("Falha na busca de endereço."); }
    }

    function getCurrentLocation(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          const {latitude,longitude}=pos.coords;
          map.setView([latitude,longitude],17);
        },()=>{ alert("Não foi possível obter sua localização."); });
      }else{ alert("Geolocalização não é suportada neste navegador."); }
    }

    /* ===== Modal controls ===== */
    const addPointModal = document.getElementById("addPointModal");
    const detailsModal = document.getElementById("detailsModal");
    const detailsModalContent = document.getElementById("detailsModalContent");
    const modalTitle = document.getElementById("modalTitle");
    const addressSuggestions = document.getElementById("address-suggestions");

    function openAddPointModal(){
      if(!auth.currentUser){ alert("Você precisa estar logado para adicionar."); signInWithGoogle(); return; }
      modalTitle.innerText="Adicionar um Novo Ponto";
      addPointModal.classList.remove("opacity-0","pointer-events-none");
      addPointModal.querySelector("div").classList.remove("scale-95");
    }

    function openEditPointModal(id){
      if(!auth.currentUser){ alert("Você precisa estar logado para editar."); signInWithGoogle(); return; }
      const p = touristPoints.find(x=>x.id===id); if(!p) return;
      closeDetailsModal();
      modalTitle.innerText="Editar Ponto Turístico";
      document.getElementById("pointId").value = p.id;
      document.getElementById("pointName").value = p.name;
      document.getElementById("pointAddress").value = p.address;
      document.getElementById("pointDescription").value = p.description;
      document.getElementById("pointCategory").value = p.category;
      document.getElementById("pointRating").value = p.rating>0?p.rating.toFixed(1):"";
      setLatLng(p.coords[0], p.coords[1]);
      placeTempMarker(p.coords[0], p.coords[1]);

      addPointModal.classList.remove("opacity-0","pointer-events-none");
      addPointModal.querySelector("div").classList.remove("scale-95");
    }

    function closeAddPointModal(){
      if(tempMarker){ map.removeLayer(tempMarker); tempMarker=null; }
      document.getElementById("addPointForm").reset();
      document.getElementById("pointId").value="";
      addressSuggestions.innerHTML="";
      addPointModal.classList.add("opacity-0","pointer-events-none");
      addPointModal.querySelector("div").classList.add("scale-95");
      document.getElementById("map").classList.remove("map-selection-mode");
    }

    /* ===== Seleção no mapa / geoloc dentro do modal ===== */
    function setLatLng(lat,lng){
      document.getElementById("pointLat").value = lat;
      document.getElementById("pointLng").value = lng;
    }

    function placeTempMarker(lat,lng){
      if(tempMarker){ tempMarker.setLatLng([lat,lng]); }
      else{
        tempMarker = L.marker([lat,lng], { draggable:true }).addTo(map);
        tempMarker.on("dragend", async (ev)=>{
          const p=ev.target.getLatLng();
          setLatLng(p.lat,p.lng);
          await reverseGeocodeToAddress(p.lat,p.lng);
        });
      }
      map.setView([lat,lng],17);
    }

    async function reverseGeocodeToAddress(lat,lng){
      try{
        const url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
        const res=await fetch(url,{headers:{'Accept-Language':'pt-BR'}});
        const data=await res.json();
        if(data?.display_name){ document.getElementById("pointAddress").value=data.display_name; }
      }catch(e){ console.warn("Reverse geocode falhou:",e); }
    }

    function startMapPick(){
      addPointModal.classList.add("opacity-0","pointer-events-none");
      document.getElementById("map").classList.add("map-selection-mode");

      map.once("click", async (e)=>{
        const {lat,lng}=e.latlng;
        setLatLng(lat,lng);
        placeTempMarker(lat,lng);
        await reverseGeocodeToAddress(lat,lng);

        addPointModal.classList.remove("opacity-0","pointer-events-none");
        document.getElementById("map").classList.remove("map-selection-mode");
      });
    }

    async function useMyLocation(){
      const locStatus=document.getElementById("locStatus");
      if(!navigator.geolocation){ alert("Geolocalização não é suportada."); return; }
      locStatus.textContent="Obtendo localização...";
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const {latitude:lat, longitude:lng}=pos.coords;
        setLatLng(lat,lng);
        placeTempMarker(lat,lng);
        await reverseGeocodeToAddress(lat,lng);
        locStatus.textContent="Localização definida.";
      },(err)=>{
        console.error(err);
        locStatus.textContent="";
        alert("Não foi possível obter sua localização. Verifique as permissões.");
      },{enableHighAccuracy:true, timeout:10000});
    }

    /* ===== Detalhes + rating ===== */
    function renderStarRating(point){
      let html = `<div class="star-rating" onmouseleave="this.innerHTML = renderStarRating(touristPoints.find(p => p.id === '${point.id}'))">`;
      const rating = point.rating;
      for(let i=1;i<=5;i++){
        let starClass="far"; if(i<=Math.round(rating)) starClass="fas rated-star";
        html += `<i class="${starClass} fa-star" onmouseover="highlightStars(this)" onclick="submitRating('${point.id}', ${i})"></i>`;
      }
      html += `</div><span class="text-gray-700 text-lg ml-2 font-bold">${rating>0?rating.toFixed(1):"N/A"}</span>`;
      return html;
    }
    function highlightStars(starEl){
      let s=starEl; while(s){ s.className="fas fa-star"; s=s.previousElementSibling; }
      s=starEl.nextElementSibling; while(s){ s.className="far fa-star"; s=s.nextElementSibling; }
    }

    async function submitRating(id, rating){
      if(!auth.currentUser){ alert("Faça login para avaliar."); signInWithGoogle(); return; }
      const p=touristPoints.find(x=>x.id===id); if(!p) return;
      const total=p.rating*p.votes+rating, votes=p.votes+1, avg=total/votes;
      try{
        await updateDoc(doc(db,"dados-guia",id),{avaliacao:avg, votos:votes});
        const fb=document.getElementById(`rating-feedback-${id}`); if(fb) fb.innerText="Obrigado por avaliar!";
        const starC=document.getElementById(`star-rating-container-${id}`); if(starC) starC.querySelector(".star-rating").classList.add("rated");
      }catch(e){ console.error("rating",e); alert("Não foi possível salvar sua avaliação."); }
    }

    function openDetailsModal(id){
      const p=touristPoints.find(x=>x.id===id); if(!p) return;
      const user=auth.currentUser;
      const adminButtons = user ? `
        <div class="flex space-x-2">
          <button onclick="openEditPointModal('${p.id}')" class="px-4 py-2 text-sm bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"><i class="fas fa-edit mr-1"></i> Editar</button>
          <button onclick="deletePoint('${p.id}')" class="px-4 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600"><i class="fas fa-trash-alt mr-1"></i> Excluir</button>
        </div>` : "";

      detailsModalContent.innerHTML = `
        <div class="p-6">
          <h3 class="text-3xl font-bold text-gray-800 mb-2">${p.name}</h3>
          <p class="text-gray-500 -mt-1 text-sm"><i class="fas fa-map-pin mr-2"></i>${p.address}</p>
          <span class="inline-block mt-2 text-sm font-semibold text-white px-3 py-1 rounded-full ${getCategoryClass(p.category)}">${p.category}</span>
          <p class="text-gray-600 mt-4">${p.description}</p>

          <div class="mt-6 flex justify-between items-center text-lg">
            <div id="star-rating-container-${p.id}" class="flex items-center">${renderStarRating(p)}</div>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${p.coords[0]},${p.coords[1]}" target="_blank" class="text-blue-500 hover:underline">
              Ver rotas <i class="fas fa-directions"></i>
            </a>
          </div>
          <div id="rating-feedback-${p.id}" class="text-sm text-green-600 h-5 mt-1"></div>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex justify-between items-center">
          ${adminButtons}
          <button onclick="closeDetailsModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 ml-auto">Fechar</button>
        </div>`;
      detailsModal.classList.remove("opacity-0","pointer-events-none");
      detailsModalContent.classList.remove("scale-95");
    }
    function closeDetailsModal(){
      detailsModal.classList.add("opacity-0","pointer-events-none");
      detailsModalContent.classList.add("scale-95");
    }

    /* ===== Autocomplete de endereço (Nominatim) ===== */
    let autocompleteTimeout;
    async function autocompleteAddress(event){
      const input=event.target;
      const suggestionsContainer=document.getElementById("address-suggestions");
      clearTimeout(autocompleteTimeout);
      autocompleteTimeout=setTimeout(async ()=>{
        if(input.value.length<3){ suggestionsContainer.innerHTML=""; return; }
        const response=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input.value)}&countrycodes=br&viewbox=-54.3,-31.5,-53.9,-31.1&bounded=1`);
        const results=await response.json();
        suggestionsContainer.innerHTML="";
        results.slice(0,5).forEach(result=>{
          const item=document.createElement("div");
          item.className="p-2 hover:bg-gray-200 cursor-pointer";
          item.textContent=result.display_name;
          item.onclick=()=>{
            input.value=result.display_name;
            const lat=parseFloat(result.lat), lng=parseFloat(result.lon);
            setLatLng(lat,lng);
            placeTempMarker(lat,lng);
            suggestionsContainer.innerHTML="";
          };
          suggestionsContainer.appendChild(item);
        });
      },300);
    }

    /* ===== Expor ao HTML ===== */
    window.signInWithGoogle = signInWithGoogle;
    window.logout = logout;
    window.openAddPointModal = openAddPointModal;
    window.closeAddPointModal = closeAddPointModal;
    window.openEditPointModal = openEditPointModal;
    window.deletePoint = deletePoint;
    window.filterPoints = filterPoints;
    window.searchAddress = searchAddress;
    window.getCurrentLocation = getCurrentLocation;
    window.startMapPick = startMapPick;
    window.useMyLocation = useMyLocation;
    window.renderStarRating = renderStarRating;
    window.highlightStars = highlightStars;
    window.submitRating = submitRating;
    window.autocompleteAddress = autocompleteAddress;

    /* start */
    listenForPoints();
  </script>
</body>
</html>
